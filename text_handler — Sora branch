# Sora simple flow: waiting_prompt
if session.get("mode") == "sora" and session.get("step") == "waiting_prompt":
    if not check_limit(chat_id):
        daily_limit = get_user_daily_limit(chat_id)
        await update.message.reply_text(
            f"‚ùå Daily Limit Reached\nYou've used all {daily_limit} generations today.\n\nUse `/redeem KEY` to get more generations",
            parse_mode="Markdown"
        )
        return

    status_msg = await update.message.reply_text("‚è≥ Generating Sora video (default size 1280x720)... This can take a while.")
    try:
        loop = asyncio.get_event_loop()
        # default Sora size set to 1280x720 (16:9). If you want different default, change here.
        # generate_sora_video returns (bytes, url)
        result = await loop.run_in_executor(None, generate_sora_video, text, 4, "1280x720")
        if isinstance(result, tuple):
            video_bytes, final_url = result
        else:
            video_bytes = result
            final_url = None

        if not video_bytes:
            raise ValueError("No video bytes received from Sora")

        import io, os as _os, tempfile
        tf = tempfile.NamedTemporaryFile(delete=False, suffix=".mp4")
        try:
            tf.write(video_bytes)
            tf.flush()
            tf.close()
            filesize = _os.path.getsize(tf.name)
            try:
                if filesize <= 50 * 1024 * 1024:
                    await update.message.reply_video(open(tf.name, "rb"), caption="üé¨ Generated by Sora")
                else:
                    await update.message.reply_document(open(tf.name, "rb"), caption="üé¨ Generated by Sora (document)")
            except Exception as send_err:
                if final_url:
                    await update.message.reply_text(f"‚úÖ Video ready but sending failed. Download here: {final_url}")
                else:
                    await update.message.reply_text(f"‚úÖ Video ready but sending failed. Error: {send_err}")
            increment_usage(chat_id)
        finally:
            try:
                _os.unlink(tf.name)
            except:
                pass

        try:
            await context.bot.delete_message(chat_id=chat_id, message_id=status_msg.message_id)
        except:
            pass
        return
    except SoraError as se:
        try:
            await context.bot.delete_message(chat_id=chat_id, message_id=status_msg.message_id)
        except:
            pass
        await update.message.reply_text(f"‚ùå Sora error: {se}")
        return
    except Exception as e:
        try:
            await context.bot.delete_message(chat_id=chat_id, message_id=status_msg.message_id)
        except:
            pass
        await update.message.reply_text(f"‚ùå Unexpected Sora error: {e}")
        return
